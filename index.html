<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepWeb - Deep16 (深十六) Integrated Development Environment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: #007acc;
            padding: 15px 20px;
            border-bottom: 2px solid #3e3e42;
        }
        
        .header h1 {
            color: white;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            color: #cdeeff;
            font-size: 14px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
        }
        
        button {
            padding: 8px 16px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        button:hover {
            background: #1177bb;
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 150px);
            gap: 10px;
            padding: 10px;
        }
        
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .memory-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: #2d2d30;
            padding: 10px;
            border-bottom: 1px solid #3e3e42;
            font-weight: bold;
            font-size: 14px;
        }
        
        .editor {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #d4d4d4;
            resize: none;
            white-space: pre;
            overflow: auto;
            line-height: 1.4;
        }
        
        .memory-controls {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            align-items: center;
        }
        
        .memory-controls label {
            font-size: 12px;
            color: #9cdcfe;
        }
        
        .memory-controls input, .memory-controls select {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 4px 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .memory-controls input {
            width: 80px;
        }
        
        .memory-display {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow: auto;
            line-height: 1.2;
        }
        
        .status-bar {
            padding: 8px 20px;
            background: #007acc;
            font-size: 12px;
            color: white;
        }
        
        .memory-line {
            display: flex;
            margin-bottom: 2px;
            padding: 2px 4px;
        }
        
        .memory-address {
            color: #569cd6;
            width: 80px;
            font-weight: bold;
        }
        
        .memory-bytes {
            color: #ce9178;
            width: 200px;
        }
        
        .memory-disassembly {
            color: #dcdcaa;
            flex: 1;
        }
        
        .pc-marker {
            background: #264f78;
            border-left: 3px solid #569cd6;
        }
        
        .symbol-marker {
            background: #2d2d30;
            border-left: 3px solid #b5cea8;
        }
        
        .registers-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
        }
        
        .register-section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 10px;
        }
        
        .section-title {
            color: #569cd6;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 13px;
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 4px;
        }
        
        .register-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        
        .register {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 4px;
        }
        
        .register:hover {
            background: #2a2d2e;
        }
        
        .register-name {
            color: #9cdcfe;
            font-weight: bold;
            font-size: 12px;
        }
        
        .register-value {
            color: #b5cea8;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .psw-display {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .psw-bits {
            display: flex;
            gap: 2px;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .psw-bit {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        .psw-label {
            font-size: 10px;
            color: #9cdcfe;
        }
        
        .psw-value {
            width: 20px;
            height: 20px;
            background: #3c3c3c;
            border: 1px solid #5a5a5a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #d4d4d4;
        }
        
        .psw-value.on {
            background: #0e639c;
            color: white;
        }
        
        .psw-hex {
            text-align: center;
            font-family: 'Courier New', monospace;
            color: #b5cea8;
            font-size: 11px;
            margin-top: 4px;
        }
        
        .special-registers {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .shadow-section {
            background: #2d2d30;
            border-left: 3px solid #ce9178;
        }
        
        .symbols-section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .symbol-table {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .symbol-row {
            display: flex;
            justify-content: space-between;
            padding: 2px 4px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .symbol-name {
            color: #9cdcfe;
        }
        
        .symbol-address {
            color: #b5cea8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>DeepWeb - Deep16 (深十六) IDE</h1>
        <div class="subtitle">Architecture v3.5 (1r11a) - Integrated Assembler & Simulator</div>
    </div>
    
    <div class="controls">
        <button id="assemble-btn">Assemble</button>
        <button id="run-btn" disabled>Run</button>
        <button id="step-btn" disabled>Step</button>
        <button id="reset-btn" disabled>Reset</button>
        <div style="flex: 1"></div>
        <button id="load-example">Load Fibonacci Example</button>
    </div>
    
    <div class="container">
        <div class="editor-panel">
            <div class="panel-header">Deep16 Assembler Editor</div>
            <textarea id="editor" class="editor" spellcheck="false">; Deep16 (深十六) Fibonacci Example
; Calculate Fibonacci numbers

.org 0x0000

main:
    MOV  SP, 0x7FFF    ; Initialize stack
    MOV  R0, 0         ; F(0) = 0
    MOV  R1, 1         ; F(1) = 1
    MOV  R2, 10        ; Calculate up to F(10)
    MOV  R3, 0x0200    ; Output address
    
fib_loop:
    ST   R0, R3, 0     ; Store current Fibonacci
    ADD  R3, 2         ; Next output address
    
    MOV  R4, R1        ; temp = current
    ADD  R1, R0        ; next = current + previous
    MOV  R0, R4        ; previous = temp
    
    SUB  R2, 1         ; decrement counter
    JNZ  R2, fib_loop  ; loop if not zero
    
    HALT

.org 0x0200
fibonacci_results:
    .word 0</textarea>
            
            <div class="symbols-section">
                <div class="section-title">Symbol Table</div>
                <div id="symbol-table" class="symbol-table">
                    <!-- Symbols will be populated here -->
                </div>
            </div>
        </div>
        
        <div class="memory-panel">
            <div class="panel-header">Deep16 Memory & Registers</div>
            <div class="registers-container">
                <!-- PSW Display -->
                <div class="register-section">
                    <div class="section-title">Processor Status Word (PSW)</div>
                    <div class="psw-display">
                        <div class="psw-bits">
                            <div class="psw-bit">
                                <div class="psw-label">DE</div>
                                <div class="psw-value" id="psw-de">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">ER</div>
                                <div class="psw-value" id="psw-er">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">DS</div>
                                <div class="psw-value" id="psw-ds">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">DR</div>
                                <div class="psw-value" id="psw-dr">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">X</div>
                                <div class="psw-value" id="psw-x1">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">X</div>
                                <div class="psw-value" id="psw-x2">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">I</div>
                                <div class="psw-value" id="psw-i">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">S</div>
                                <div class="psw-value" id="psw-s">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">C</div>
                                <div class="psw-value" id="psw-c">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">V</div>
                                <div class="psw-value" id="psw-v">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">Z</div>
                                <div class="psw-value" id="psw-z">0</div>
                            </div>
                            <div class="psw-bit">
                                <div class="psw-label">N</div>
                                <div class="psw-value" id="psw-n">0</div>
                            </div>
                        </div>
                        <div class="psw-hex" id="psw-hex">Full: 0x0000</div>
                    </div>
                </div>
                
                <!-- General Purpose Registers -->
                <div class="register-section">
                    <div class="section-title">General Purpose Registers (R0-R15)</div>
                    <div class="register-grid" id="register-grid">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
                
                <!-- Segment Registers -->
                <div class="register-section">
                    <div class="section-title">Segment Registers</div>
                    <div class="special-registers">
                        <div class="register">
                            <span class="register-name">CS</span>
                            <span class="register-value" id="reg-cs">0x0000</span>
                        </div>
                        <div class="register">
                            <span class="register-name">DS</span>
                            <span class="register-value" id="reg-ds">0x0000</span>
                        </div>
                        <div class="register">
                            <span class="register-name">SS</span>
                            <span class="register-value" id="reg-ss">0x0000</span>
                        </div>
                        <div class="register">
                            <span class="register-name">ES</span>
                            <span class="register-value" id="reg-es">0x0000</span>
                        </div>
                    </div>
                </div>
                
                <!-- Shadow Registers -->
                <div class="register-section shadow-section">
                    <div class="section-title">Shadow Registers (Interrupt Context)</div>
                    <div class="special-registers">
                        <div class="register">
                            <span class="register-name">PSW'</span>
                            <span class="register-value" id="reg-psw-shadow">0x0000</span>
                        </div>
                        <div class="register">
                            <span class="register-name">PC'</span>
                            <span class="register-value" id="reg-pc-shadow">0x0000</span>
                        </div>
                        <div class="register">
                            <span class="register-name">CS'</span>
                            <span class="register-value" id="reg-cs-shadow">0x0000</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel-header">Memory Display (Word Addressing)</div>
            <div class="memory-controls">
                <label for="memory-start-address">Start Address:</label>
                <input type="text" id="memory-start-address" value="0x0000" placeholder="0x0000">
                <label for="symbol-select">or select symbol:</label>
                <select id="symbol-select">
                    <option value="">-- Select Symbol --</option>
                </select>
                <button id="memory-jump-btn">Jump</button>
            </div>
            <div id="memory-display" class="memory-display">
                <!-- Memory content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <div id="status-bar" class="status-bar">
        DeepWeb Ready - Architecture v3.5 (1r11a) - Enter assembly code and click 'Assemble'
    </div>

    <script>
        // Enhanced DeepWeb with Symbol Table and Configurable Memory View
        class DeepWeb {
            constructor() {
                this.memory = new Array(65536).fill(0);
                this.registers = new Array(16).fill(0);
                this.segmentRegisters = { CS: 0, DS: 0, SS: 0, ES: 0 };
                this.shadowRegisters = { PSW: 0, PC: 0, CS: 0 };
                this.psw = 0;
                this.labels = {};
                this.symbols = {};
                this.running = false;
                this.pc = 0;
                this.memoryStartAddress = 0;
                
                // Initialize registers
                this.registers[13] = 0x7FFF; // SP
                this.registers[15] = 0x0000; // PC
                
                this.setupEventListeners();
                this.updateMemoryDisplay();
                this.updateAllRegisterDisplays();
                this.updateSymbolTable();
            }
            
            setupEventListeners() {
                document.getElementById('assemble-btn').addEventListener('click', () => this.assemble());
                document.getElementById('run-btn').addEventListener('click', () => this.run());
                document.getElementById('step-btn').addEventListener('click', () => this.step());
                document.getElementById('reset-btn').addEventListener('click', () => this.reset());
                document.getElementById('load-example').addEventListener('click', () => this.loadExample());
                document.getElementById('memory-jump-btn').addEventListener('click', () => this.jumpToMemoryAddress());
                document.getElementById('symbol-select').addEventListener('change', (e) => this.onSymbolSelect(e));
                
                // Allow Enter key in memory address input
                document.getElementById('memory-start-address').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.jumpToMemoryAddress();
                    }
                });
            }
            
            assemble() {
                const source = document.getElementById('editor').value;
                this.status("Assembling...");
                
                try {
                    const lines = source.split('\n');
                    let address = 0;
                    this.labels = {};
                    this.symbols = {};
                    
                    // First pass: collect labels and resolve .org
                    let lineNumber = 0;
                    for (let line of lines) {
                        lineNumber++;
                        line = this.cleanLine(line);
                        if (!line) continue;
                        
                        if (line.startsWith('.org')) {
                            const orgValue = this.parseImmediate(line.split(' ')[1]);
                            address = orgValue;
                        } else if (line.endsWith(':')) {
                            const label = line.slice(0, -1);
                            this.labels[label] = address;
                            this.symbols[label] = { address: address, type: 'label', line: lineNumber };
                        } else if (line.startsWith('.word')) {
                            address += 2;
                        } else {
                            address += 2;
                        }
                    }
                    
                    // Second pass: assemble instructions
                    address = 0;
                    this.memory.fill(0);
                    
                    lineNumber = 0;
                    for (let line of lines) {
                        lineNumber++;
                        line = this.cleanLine(line);
                        if (!line) continue;
                        
                        if (line.startsWith('.org')) {
                            const orgValue = this.parseImmediate(line.split(' ')[1]);
                            address = orgValue;
                        } else if (line.endsWith(':')) {
                            // Label - already handled
                        } else if (line.startsWith('.word')) {
                            const value = this.parseImmediate(line.split(' ')[1]);
                            this.memory[address] = value & 0xFFFF;
                            address += 2;
                        } else {
                            const instruction = this.encodeInstruction(line, address, lineNumber);
                            if (instruction !== null) {
                                this.memory[address] = instruction;
                                address += 2;
                            } else {
                                throw new Error(`Line ${lineNumber}: Unknown instruction: ${line}`);
                            }
                        }
                    }
                    
                    this.registers[15] = 0x0000; // Start at beginning
                    this.status("Assembly successful! Program loaded.");
                    document.getElementById('run-btn').disabled = false;
                    document.getElementById('step-btn').disabled = false;
                    document.getElementById('reset-btn').disabled = false;
                    this.updateMemoryDisplay();
                    this.updateAllRegisterDisplays();
                    this.updateSymbolTable();
                    this.updateSymbolSelect();
                    
                } catch (error) {
                    this.status("Assembly error: " + error.message);
                }
            }
            
            updateSymbolTable() {
                const table = document.getElementById('symbol-table');
                let html = '';
                
                if (Object.keys(this.symbols).length === 0) {
                    html = '<div style="color: #666; text-align: center; padding: 10px;">No symbols defined</div>';
                } else {
                    for (const [name, symbol] of Object.entries(this.symbols)) {
                        html += `
                            <div class="symbol-row">
                                <span class="symbol-name">${name}</span>
                                <span class="symbol-address">0x${symbol.address.toString(16).padStart(4, '0')}</span>
                            </div>
                        `;
                    }
                }
                
                table.innerHTML = html;
            }
            
            updateSymbolSelect() {
                const select = document.getElementById('symbol-select');
                let html = '<option value="">-- Select Symbol --</option>';
                
                for (const [name, symbol] of Object.entries(this.symbols)) {
                    html += `<option value="${symbol.address}">${name} (0x${symbol.address.toString(16).padStart(4, '0')})</option>`;
                }
                
                select.innerHTML = html;
            }
            
            onSymbolSelect(event) {
                const address = parseInt(event.target.value);
                if (!isNaN(address)) {
                    this.memoryStartAddress = address;
                    this.updateMemoryDisplay();
                }
            }
            
            jumpToMemoryAddress() {
                const input = document.getElementById('memory-start-address');
                let address = input.value.trim();
                
                // Handle hex format
                if (address.startsWith('0x')) {
                    address = parseInt(address.substring(2), 16);
                } else {
                    address = parseInt(address);
                }
                
                if (!isNaN(address) && address >= 0 && address < this.memory.length) {
                    this.memoryStartAddress = address;
                    this.updateMemoryDisplay();
                    input.value = '0x' + address.toString(16).padStart(4, '0');
                } else {
                    this.status("Invalid memory address: " + input.value);
                }
            }
            
            cleanLine(line) {
                return line.split(';')[0].trim().replace(/\s+/g, ' ');
            }
            
            parseImmediate(value) {
                if (value.startsWith('0x')) {
                    return parseInt(value.substring(2), 16);
                }
                return parseInt(value);
            }
            
            parseRegister(reg) {
                const regMap = {
                    'R0': 0, 'R1': 1, 'R2': 2, 'R3': 3, 'R4': 4, 'R5': 5, 'R6': 6, 'R7': 7,
                    'R8': 8, 'R9': 9, 'R10': 10, 'R11': 11, 'R12': 12, 'R13': 13, 'R14': 14, 'R15': 15,
                    'SP': 13, 'FP': 12, 'LR': 14, 'PC': 15
                };
                const result = regMap[reg.toUpperCase()];
                if (result === undefined) {
                    throw new Error(`Unknown register: ${reg}`);
                }
                return result;
            }
            
            encodeInstruction(line, address, lineNumber) {
                const parts = line.split(/[\s,]+/).filter(part => part);
                if (parts.length === 0) return null;
                
                const mnemonic = parts[0].toUpperCase();
                
                try {
                    switch (mnemonic) {
                        case 'MOV':
                            if (parts.length >= 3) {
                                const rd = this.parseRegister(parts[1]);
                                // Check if second operand is register or immediate
                                if (parts[2].startsWith('R') || parts[2] === 'SP' || parts[2] === 'FP' || parts[2] === 'LR' || parts[2] === 'PC') {
                                    const rs = this.parseRegister(parts[2]);
                                    const imm = parts[3] ? this.parseImmediate(parts[3]) : 0;
                                    // MOV Rd, Rs, imm2 format
                                    return 0b1111100000000000 | (rd << 8) | (rs << 4) | (imm & 0x3);
                                } else {
                                    // MOV Rd, imm (using LSI encoding)
                                    const imm = this.parseImmediate(parts[2]);
                                    if (imm >= -16 && imm <= 15) {
                                        return 0b1111110000000000 | (rd << 8) | ((imm & 0x1F) << 4);
                                    } else {
                                        throw new Error(`Immediate value ${imm} out of range for MOV (-16 to 15)`);
                                    }
                                }
                            }
                            break;
                            
                        case 'ADD':
                            if (parts.length >= 3) {
                                const rd = this.parseRegister(parts[1]);
                                if (parts[2].startsWith('R') || parts[2] === 'SP' || parts[2] === 'FP' || parts[2] === 'LR' || parts[2] === 'PC') {
                                    const rs = this.parseRegister(parts[2]);
                                    // ADD Rd, Rs (register mode)
                                    return 0b1100000000000000 | (rd << 8) | (rs << 4);
                                } else {
                                    const imm = this.parseImmediate(parts[2]);
                                    // ADD Rd, imm4 (immediate mode)
                                    return 0b1100001000000000 | (rd << 8) | (imm & 0xF);
                                }
                            }
                            break;
                            
                        case 'SUB':
                            if (parts.length >= 3) {
                                const rd = this.parseRegister(parts[1]);
                                if (parts[2].startsWith('R') || parts[2] === 'SP' || parts[2] === 'FP' || parts[2] === 'LR' || parts[2] === 'PC') {
                                    const rs = this.parseRegister(parts[2]);
                                    // SUB Rd, Rs (register mode)
                                    return 0b1100010000000000 | (rd << 8) | (rs << 4);
                                } else {
                                    const imm = this.parseImmediate(parts[2]);
                                    // SUB Rd, imm4 (immediate mode)
                                    return 0b1100011000000000 | (rd << 8) | (imm & 0xF);
                                }
                            }
                            break;
                            
                        case 'ST':
                            if (parts.length >= 4) {
                                const rd = this.parseRegister(parts[1]);
                                const rb = this.parseRegister(parts[2]);
                                const offset = this.parseImmediate(parts[3]);
                                // ST Rd, Rb, offset5
                                return 0b1010000000000000 | (rd << 8) | (rb << 4) | (offset & 0x1F);
                            }
                            break;
                            
                        case 'LD':
                            if (parts.length >= 4) {
                                const rd = this.parseRegister(parts[1]);
                                const rb = this.parseRegister(parts[2]);
                                const offset = this.parseImmediate(parts[3]);
                                // LD Rd, Rb, offset5
                                return 0b1000000000000000 | (rd << 8) | (rb << 4) | (offset & 0x1F);
                            }
                            break;
                            
                        case 'JNZ':
                            if (parts.length >= 3) {
                                const rcond = this.parseRegister(parts[1]);
                                const targetLabel = parts[2];
                                let targetAddress = this.labels[targetLabel];
                                if (targetAddress === undefined) {
                                    throw new Error(`Unknown label: ${targetLabel}`);
                                }
                                const offset = Math.floor((targetAddress - (address + 2)) / 2); // Word offset
                                if (offset < -256 || offset > 255) {
                                    throw new Error(`Jump target too far: ${offset} words from current position`);
                                }
                                // JNZ Rcond, target (using JMP with condition)
                                return 0b1110010000000000 | ((offset & 0x1FF) << 0);
                            }
                            break;
                            
                        case 'HALT':
                            return 0b1111111111110001; // HALT system call
                            
                        case 'NOP':
                            return 0b1111111111110000; // NOP system call
                    }
                } catch (error) {
                    throw new Error(`Line ${lineNumber}: ${error.message}`);
                }
                
                return null;
            }
            
            // ... (run, step, execute methods remain the same as previous version)
            run() {
                this.running = true;
                this.status("Running program...");
                this.runCycle();
            }
            
            runCycle() {
                if (!this.running) return;
                
                try {
                    this.step();
                    if (this.running) {
                        setTimeout(() => this.runCycle(), 50);
                    }
                } catch (error) {
                    this.running = false;
                    this.status("Runtime error: " + error.message);
                }
            }
            
            step() {
                const pc = this.registers[15];
                if (pc >= this.memory.length) {
                    this.running = false;
                    this.status("Program counter out of bounds");
                    return;
                }
                
                const instruction = this.memory[pc];
                this.registers[15] += 2;
                
                // Decode and execute instruction
                const opcode = (instruction >> 13) & 0x7;
                
                try {
                    switch (opcode) {
                        case 0b100: this.executeMemoryOp(instruction); break;
                        case 0b110: this.executeALUOp(instruction); break;
                        case 0b111: 
                            if ((instruction >> 12) === 0b1110) {
                                this.executeJump(instruction);
                            } else if ((instruction >> 10) === 0b111110) {
                                this.executeMOV(instruction);
                            } else if ((instruction >> 9) === 0b1111110) {
                                this.executeLSI(instruction);
                            } else if ((instruction >> 13) === 0b11111) {
                                this.executeSystem(instruction);
                            }
                            break;
                    }
                } catch (error) {
                    this.running = false;
                    throw error;
                }
                
                this.updatePSWFlags();
                this.updateMemoryDisplay();
                this.updateAllRegisterDisplays();
            }
            
            executeMemoryOp(instruction) {
                const d = (instruction >> 12) & 0x1;
                const rd = (instruction >> 8) & 0xF;
                const rb = (instruction >> 4) & 0xF;
                const offset = instruction & 0x1F;
                
                const address = this.registers[rb] + offset;
                
                if (d === 0) { // LD
                    if (address < this.memory.length) {
                        this.registers[rd] = this.memory[address];
                    }
                } else { // ST
                    if (address < this.memory.length) {
                        this.memory[address] = this.registers[rd];
                    }
                }
            }
            
            executeALUOp(instruction) {
                const aluOp = (instruction >> 10) & 0x7;
                const rd = (instruction >> 8) & 0xF;
                const w = (instruction >> 7) & 0x1;
                const i = (instruction >> 6) & 0x1;
                const operand = instruction & 0xF;
                
                let result;
                let operandValue;
                
                if (i === 0) {
                    operandValue = this.registers[operand];
                } else {
                    operandValue = operand;
                }
                
                switch (aluOp) {
                    case 0b000: result = this.registers[rd] + operandValue; break;
                    case 0b001: result = this.registers[rd] - operandValue; break;
                    case 0b010: result = this.registers[rd] & operandValue; break;
                    case 0b011: result = this.registers[rd] | operandValue; break;
                    case 0b100: result = this.registers[rd] ^ operandValue; break;
                    default: result = this.registers[rd]; break;
                }
                
                if (w === 1) {
                    this.registers[rd] = result & 0xFFFF;
                }
                
                this.lastALUResult = result;
            }
            
            executeMOV(instruction) {
                const rd = (instruction >> 8) & 0xF;
                const rs = (instruction >> 4) & 0xF;
                const imm = instruction & 0x3;
                this.registers[rd] = this.registers[rs] + imm;
            }
            
            executeLSI(instruction) {
                const rd = (instruction >> 8) & 0xF;
                let imm = (instruction >> 4) & 0x1F;
                if (imm & 0x10) imm |= 0xFFE0;
                this.registers[rd] = imm;
            }
            
            executeJump(instruction) {
                const condition = (instruction >> 9) & 0x7;
                let offset = instruction & 0x1FF;
                if (offset & 0x100) offset |= 0xFE00;
                
                let shouldJump = false;
                switch (condition) {
                    case 0b000: shouldJump = true; break;
                    case 0b001: shouldJump = (this.psw & (1 << 1)) !== 0; break;
                    case 0b010: shouldJump = (this.psw & (1 << 1)) === 0; break;
                }
                
                if (shouldJump) {
                    this.registers[15] += offset * 2;
                }
            }
            
            executeSystem(instruction) {
                const sysOp = instruction & 0x7;
                switch (sysOp) {
                    case 0b001: 
                        this.running = false;
                        this.status("Program halted by HLT instruction");
                        break;
                }
            }
            
            updatePSWFlags() {
                this.psw = 0;
                if (this.lastALUResult !== undefined) {
                    const result = this.lastALUResult & 0xFFFF;
                    if (result === 0) this.psw |= (1 << 1);
                    if (result & 0x8000) this.psw |= (1 << 0);
                    if (this.lastALUResult > 0xFFFF || this.lastALUResult < 0) {
                        this.psw |= (1 << 3);
                    }
                }
            }
            
            reset() {
                this.running = false;
                this.registers.fill(0);
                this.registers[13] = 0x7FFF;
                this.registers[15] = 0x0000;
                this.psw = 0;
                this.memory.fill(0);
                this.memoryStartAddress = 0;
                document.getElementById('memory-start-address').value = '0x0000';
                this.updateMemoryDisplay();
                this.updateAllRegisterDisplays();
                this.status("Reset complete");
            }
            
            updateMemoryDisplay() {
                const display = document.getElementById('memory-display');
                let html = '';
                const startAddr = this.memoryStartAddress;
                const endAddr = Math.min(startAddr + 512, this.memory.length);
                
                for (let addr = startAddr; addr < endAddr; addr += 16) {
                    const currentPC = this.registers[15];
                    const isPC = (addr <= currentPC && currentPC < addr + 16);
                    let lineClass = 'memory-line';
                    if (isPC) lineClass += ' pc-marker';
                    
                    // Check if this line contains any symbols
                    let hasSymbol = false;
                    for (const [name, symbol] of Object.entries(this.symbols)) {
                        if (addr <= symbol.address && symbol.address < addr + 16) {
                            hasSymbol = true;
                            break;
                        }
                    }
                    if (hasSymbol) lineClass += ' symbol-marker';
                    
                    html += `<div class="${lineClass}">`;
                    html += `<div class="memory-address">W:0x${addr.toString(16).padStart(4, '0')}</div>`;
                    html += `<div class="memory-bytes">`;
                    
                    for (let i = 0; i < 16; i++) {
                        const wordAddr = addr + i;
                        if (wordAddr < this.memory.length) {
                            const word = this.memory[wordAddr];
                            html += `${word.toString(16).padStart(4, '0')} `;
                        }
                    }
                    
                    html += `</div>`;
                    
                    // Show symbols on this line
                    const symbolsHere = [];
                    for (const [name, symbol] of Object.entries(this.symbols)) {
                        if (addr <= symbol.address && symbol.address < addr + 16) {
                            symbolsHere.push(name);
                        }
                    }
                    if (symbolsHere.length > 0) {
                        html += `<div class="memory-disassembly">; ${symbolsHere.join(', ')}</div>`;
                    }
                    
                    html += `</div>`;
                }
                
                display.innerHTML = html;
            }
            
            updateAllRegisterDisplays() {
                this.updateGeneralRegisters();
                this.updatePSWDisplay();
                this.updateSegmentRegisters();
                this.updateShadowRegisters();
            }
            
            updateGeneralRegisters() {
                const grid = document.getElementById('register-grid');
                let html = '';
                for (let i = 0; i < 16; i++) {
                    const regName = i === 12 ? 'FP' : i === 13 ? 'SP' : i === 14 ? 'LR' : i === 15 ? 'PC' : `R${i}`;
                    const value = this.registers[i];
                    const isPC = i === 15;
                    const valueClass = isPC ? 'register-value pc-value' : 'register-value';
                    html += `
                        <div class="register">
                            <span class="register-name">${regName}</span>
                            <span class="${valueClass}">0x${value.toString(16).padStart(4, '0')}</span>
                        </div>
                    `;
                }
                grid.innerHTML = html;
            }
            
            updatePSWDisplay() {
                const bits = [
                    { id: 'psw-de', bit: 17 }, { id: 'psw-er', bit: 13 }, 
                    { id: 'psw-ds', bit: 12 }, { id: 'psw-dr', bit: 11 },
                    { id: 'psw-x1', bit: 6 }, { id: 'psw-x2', bit: 7 },
                    { id: 'psw-i', bit: 5 }, { id: 'psw-s', bit: 4 },
                    { id: 'psw-c', bit: 3 }, { id: 'psw-v', bit: 2 },
                    { id: 'psw-z', bit: 1 }, { id: 'psw-n', bit: 0 }
                ];
                
                bits.forEach(bitInfo => {
                    const element = document.getElementById(bitInfo.id);
                    const value = (this.psw >> bitInfo.bit) & 1;
                    element.textContent = value;
                    element.className = value ? 'psw-value on' : 'psw-value';
                });
                
                document.getElementById('psw-hex').textContent = `Full: 0x${this.psw.toString(16).padStart(4, '0')}`;
            }
            
            updateSegmentRegisters() {
                document.getElementById('reg-cs').textContent = `0x${this.segmentRegisters.CS.toString(16).padStart(4, '0')}`;
                document.getElementById('reg-ds').textContent = `0x${this.segmentRegisters.DS.toString(16).padStart(4, '0')}`;
                document.getElementById('reg-ss').textContent = `0x${this.segmentRegisters.SS.toString(16).padStart(4, '0')}`;
                document.getElementById('reg-es').textContent = `0x${this.segmentRegisters.ES.toString(16).padStart(4, '0')}`;
            }
            
            updateShadowRegisters() {
                document.getElementById('reg-psw-shadow').textContent = `0x${this.shadowRegisters.PSW.toString(16).padStart(4, '0')}`;
                document.getElementById('reg-pc-shadow').textContent = `0x${this.shadowRegisters.PC.toString(16).padStart(4, '0')}`;
                document.getElementById('reg-cs-shadow').textContent = `0x${this.shadowRegisters.CS.toString(16).padStart(4, '0')}`;
            }
            
            status(message) {
                document.getElementById('status-bar').textContent = `DeepWeb: ${message}`;
            }
            
            loadExample() {
                // Already loaded as default
                this.status("Fibonacci example ready - click 'Assemble' to compile");
            }
        }

        // Initialize DeepWeb when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.deepWeb = new DeepWeb();
        });
    </script>
</body>
</html>
